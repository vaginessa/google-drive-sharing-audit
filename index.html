<!DOCTYPE html>
<html>
<head>
  <base target="_top"/>
  <title>Google Drive Permissions Audit</title>
  <link href="https://fonts.googleapis.com/css?family=Oxygen+Mono" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" rel="stylesheet"/>
  <style type="text/css">
    .main {
      padding: 1em;
      font-family: 'Oxygen Mono', monospace;
    }
    .error {
      color: #f00;
    }
    .status {
      color: #888;
    }
  </style>
  <script type="text/javascript">
    // Process items in groups of "count"
    // Higher is faster but more resource intensive (quota) and less responsive to user (eg. pausing, aborting)
    // Be sure to update indicator in body 
    var count = 10;
    
    // Initialize global variables
    var sheet = {};
    var paused = true;
    var state = 0;
    
    // DOM manipulation library instead of loading jQuery
    function find (selector) {
      return document.querySelector(selector)
    }
    
    function text (el, contents) {
      el.innerText = contents
      el.textContents = contents
    }
    
    // Error handler
    function failure (event) {
      text(find('#error'), 'Error: ' + event.message)
      switch (state) {
        case 0:
          text(find('#sheet-status'), 'error')
        case 1:
          text(find('#folder-status'), 'error')
          break
        case 2:
          text(find('#file-status'), 'error')
          break
      }
      console.error(event)
    }
    
    // Create new spreadsheet
    function sheetSuccess (output) {
      sheet = output
      text(find('#output'), sheet.id)
      find('#output').href = sheet.url
      state = 1
      text(find('#sheet-status'), 'complete')
      if (paused) {
        text(find('#folder-status'), 'paused')
        find('#pause').value = 'Resume'
        find('#pause').removeAttribute('disabled')
      } else {
        text(find('#folder-status'), 'in progress')
        google.script.run.withSuccessHandler(folderSuccess).withFailureHandler(failure).listFolders(sheet.id, 0, count)
      }
    }
    
    // List folders
    function folderSuccess (args) {
      folders = args.index
      text(find('#folder-index'), (folders + 1).toString())
      if (args.done === true) {  // Finished listing folders
        state = 2
        text(find('#folder-status'), 'complete')
        if (paused) {
          text(find('#file-status'), 'paused')
        } else {
          text(find('#file-status'), 'in progress')
          google.script.run.withSuccessHandler(fileSuccess).withFailureHandler(failure).listFiles(sheet.id, 0, count)
        }
      } else {  // Continue listing folders
        if (paused) {
          text(find('#folder-status'), 'paused')
        } else {
          google.script.run.withSuccessHandler(folderSuccess).withFailureHandler(failure).listFolders(sheet.id, folders + 1, count)
        }
      }
      if (paused) {
        find('#pause').value = 'Resume'
        find('#pause').removeAttribute('disabled')
      }
    }
    
    // List files
    function fileSuccess (args) {
      files = args.index
      text(find('#file-index'), (files + 1).toString())
      if (args.done === true) {  // Finished listing files
        state = 3
        text(find('#file-status'), 'complete')
        find('#pause').setAttribute('disabled', 'disabled')
        find('#pause').value = 'Complete'
      } else {  // Continue listing files
        if (paused) {
          text(find('#file-status'), 'paused')
        } else {
          google.script.run.withSuccessHandler(fileSuccess).withFailureHandler(failure).listFiles(sheet.id, files + 1, count)
        }
      }
      if (paused) {
        find('#pause').value = 'Resume'
        find('#pause').removeAttribute('disabled')
      }
    }
    
    // Pausing
    function togglePause () {
      paused = !paused
      if (paused) {
        find('#pause').setAttribute('disabled', 'disabled')
        find('#pause').value = 'Pausing...'
      } else {
        find('#pause').value = 'Pause'
        switch (state) {
          case 0:
            text(find('#sheet-status'), 'in progress')
            google.script.run.withSuccessHandler(sheetSuccess).withFailureHandler(failure).createSpreadsheet()
            break
          case 1:
            text(find('#folder-status'), 'in progress')
            google.script.run.withSuccessHandler(folderSuccess).withFailureHandler(failure).listFolders(sheet.id, folders + 1, count)
            break
          case 2:
            text(find('#file-status'), 'in progress')
            google.script.run.withSuccessHandler(fileSuccess).withFailureHandler(failure).listFiles(sheet.id, files + 1, count)
            break
        }
      }
      return false
    }
  </script>
</head>
<body>
  <div class="main">
    <h1>Google Drive Permissions Audit</h1>
    <span class="subtitle">Scans folders and files in a user's Google Drive for permissions and stores the information in a spreadsheet.</span>
    <br>
    <span>Note: Count of processed folders/files will update in increments of 10.</span>
    <ol>
      <li>Setup:&nbsp;<span id="sheet-status" class="status">queued</span></li>
      <li>
        <div>Folders:&nbsp;<span id="folder-index"></span>&nbsp;<span id="folder-status" class="status">queued</span></div>
        <div>Files:&nbsp;<span id="file-index"></span>&nbsp;<span id="file-status" class="status">queued</span></div>
      </li>
      <li>Results in sheet:&nbsp;<a id="output" href="#" target="_blank"></a></li>
    </ol>
    <input id="pause" type="button" value="Start" onclick="togglePause()" />
    <div id="error" class="error"></div>
  </div>
</body>
</html>
